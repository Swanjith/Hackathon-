@startuml System Architecture - Smart Queue Routing System (SQRS)

!define RECTANGLE class

title Smart Queue Routing System (SQRS) - System Architecture\nCUCB-OTA: Causal Uplift Contextual Bandit + Optimal Transport Assignment

skinparam componentStyle rectangle
skinparam defaultFontName Arial
skinparam defaultFontSize 11

package "Frontend Layer" #LightBlue {
    component [React Frontend] as Frontend {
        component [Dashboard] as Dashboard
        component [AgentGrid] as AgentGrid
        component [MetricsChart] as MetricsChart
        component [PolicyComparison] as PolicyComparison
        component [SimulationControl] as SimControl
        component [KPICards] as KPICards
    }
    note right of Frontend : React.js UI\nReal-time visualization\nWebSocket connections
}

package "API Layer" #LightGreen {
    component [Flask API Server] as API {
        component [REST Endpoints] as REST
        component [WebSocket Handler] as WS
        component [Simulation Manager] as SimManager
    }
    note right of API : Flask + Flask-SocketIO\nRESTful API\nReal-time updates
}

package "Core System" #LightYellow {
    
    package "Main Entry" {
        component [main.py] as MainEntry
        note right of MainEntry : Orchestrates entire workflow\nModel training\nSimulation execution
    }
    
    package "Configuration" {
        component [config.py] as Config
        note right of Config : Centralized configuration\nHyperparameters\nSystem parameters
    }
    
    package "Data Layer" {
        component [SyntheticDataGenerator] as DataGen
        component [Data Storage] as DataStorage
    }
    
    package "ML Models" {
        component [UpliftModel] as UpliftModel {
            + train()
            + predict_uplift()
            + _featurize()
        }
        component [CapacityModel] as CapacityModel {
            + train()
            + predict_aht()
            + check_capacity()
        }
        note right of UpliftModel : X-Learner for CATE\nCausal Uplift Prediction
        note right of CapacityModel : AHT Prediction\nCapacity Constraints
    }
    
    package "Routing Engine" {
        component [RoutingScorer] as Scorer {
            + compute_routing_matrix()
            + update_dual_variables()
            + get_dual_state()
        }
        component [AssignmentSolver] as Assignment {
            + solve_hungarian()
            + solve_greedy_with_capacity()
            + hybrid_solve()
        }
        note right of Scorer : Routing Score = Uplift\n- λ₁·AHT - λ₂·SLA - λ₃·Fairness
        note right of Assignment : Hungarian Algorithm (one-to-one)\nGreedy (one-to-many)
    }
    
    package "Simulation" {
        component [RoutingSimulator] as Simulator {
            + run_simulation()
            + _decay_agent_loads()
        }
        component [Policy Functions] as Policies {
            + cucb_ota_policy()
            + fcfs_policy()
            + skill_based_greedy_policy()
        }
        component [ResultsVisualizer] as Visualizer {
            + plot_policy_comparison()
            + plot_convergence()
            + plot_workload()
        }
    }
    
    package "Evaluation" {
        component [MetricsTracker] as Metrics {
            + record_batch()
            + get_summary_stats()
            + get_dataframe()
        }
        component [OffPolicyEvaluator] as OPE {
            + log_interaction()
            + estimate_value()
            + doubly_robust_estimate()
        }
    }
}

package "Outputs" #LightCoral {
    component [Logs/CSV] as Logs
    component [Visualizations] as Viz
    component [Reports] as Reports
}

' Frontend to API connections
Frontend --> API : HTTP/REST
Frontend --> WS : WebSocket

' API to Core System connections
API --> Simulator : Control simulation
API --> Metrics : Get metrics
API --> Scorer : Compute routing matrix
API --> DataGen : Get agents/customers

' Main execution flow
MainEntry --> Config : Read configuration
MainEntry --> DataGen : Generate synthetic data
MainEntry --> UpliftModel : Train models
MainEntry --> CapacityModel : Train models
MainEntry --> Simulator : Run experiments

' Model dependencies
Scorer --> UpliftModel : Predict uplift
Scorer --> CapacityModel : Predict AHT & capacity
Scorer --> Config : Read constraints & dual params

' Routing flow
Simulator --> Scorer : Compute routing scores
Scorer --> Assignment : Solve optimal assignment
Assignment --> Simulator : Return assignments
Simulator --> Policies : Apply routing policy

' Evaluation flow
Simulator --> Metrics : Record metrics
Simulator --> OPE : Log interactions
Metrics --> Logs : Export CSV
OPE --> Reports : Generate OPE reports

' Visualization flow
MainEntry --> Visualizer : Generate plots
Visualizer --> Viz : Save PNG files
Metrics --> Visualizer : Provide data

' Data flow
DataGen --> UpliftModel : Historical data
DataGen --> CapacityModel : Historical data
DataGen --> Simulator : Customer batches
DataGen --> DataStorage : Store agents/interactions

' Policy implementations
Policies --> Scorer : Use routing scorer
Policies --> Assignment : Use assignment solver

' Configuration dependencies
UpliftModel --> Config : Model parameters
CapacityModel --> Config : Capacity rules
Scorer --> Config : Constraint budgets
Assignment --> Config : Channel rules
Simulator --> Config : Simulation params

@enduml

