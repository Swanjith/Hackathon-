@startuml System Flow - SQRS Process Flow

title Smart Queue Routing System - Process Flow Diagram\nShowing Data Flow and Processing Steps

skinparam defaultFontName Arial
skinparam defaultFontSize 10
skinparam sequenceArrowThickness 2

actor User
participant "Frontend\n(Dashboard)" as Frontend
participant "API Server\n(Flask)" as API
participant "Main Entry\n(main.py)" as Main
participant "Data Generator\n(SyntheticData)" as DataGen
participant "Uplift Model\n(X-Learner)" as Uplift
participant "Capacity Model\n(AHT Predictor)" as Capacity
participant "Routing Scorer\n(Score Computation)" as Scorer
participant "Assignment Solver\n(Hungarian/Greedy)" as Assignment
participant "Simulator\n(Routing Engine)" as Simulator
participant "Metrics Tracker" as Metrics
participant "Visualizer\n(Results)" as Viz

== Initialization Phase ==

User -> Main : Execute main.py
activate Main

Main -> Config : Load configuration
Main -> DataGen : Initialize data generator
activate DataGen

DataGen -> DataGen : Generate agents (NUM_AGENTS)
DataGen -> DataGen : Generate historical data (5000 interactions)

Main -> Uplift : Train X-Learner model
activate Uplift
DataGen -> Uplift : Historical interactions
Uplift -> Uplift : Train mu0, mu1, tau0, tau1 models

Main -> Capacity : Train AHT model
activate Capacity
DataGen -> Capacity : Historical interactions
Capacity -> Capacity : Train AHT predictor

Main -> Scorer : Initialize RoutingScorer
activate Scorer
Scorer -> Uplift : Reference to model
Scorer -> Capacity : Reference to model
Scorer -> Config : Initialize dual variables (λ_aht, λ_sla, λ_fairness)

== Simulation Phase ==

loop For each batch (n_batches)
    Main -> Simulator : Run simulation batch
    activate Simulator
    
    Simulator -> DataGen : Generate customer batch
    DataGen --> Simulator : Customer DataFrame
    
    Simulator -> Scorer : Compute routing matrix
    activate Scorer
    
    loop For each (customer, agent) pair
        Scorer -> Uplift : Predict uplift(customer, agent)
        Uplift --> Scorer : (uplift_score, uncertainty)
        
        Scorer -> Capacity : Predict AHT(customer, agent)
        Capacity --> Scorer : predicted_aht
        
        Scorer -> Capacity : Check capacity(agent, channel)
        Capacity --> Scorer : can_handle
        
        Scorer -> Scorer : Compute routing score\nRS = uplift - λ₁·AHT - λ₂·SLA - λ₃·Fairness
    end
    
    Scorer --> Simulator : Routing score matrix (K×M)
    deactivate Scorer
    
    Simulator -> Assignment : Solve optimal assignment
    activate Assignment
    
    alt Voice channel (one-to-one)
        Assignment -> Assignment : Hungarian algorithm
    else Chat/Email (one-to-many)
        Assignment -> Assignment : Greedy with capacity
    end
    
    Assignment --> Simulator : List of (customer_idx, agent_idx) assignments
    deactivate Assignment
    
    loop For each assignment
        Simulator -> DataGen : Simulate interaction outcome
        DataGen --> Simulator : {csat, aht, sla_met, skill_match}
        
        Simulator -> Simulator : Update agent load
        Simulator -> Metrics : Record assignment
    end
    
    Simulator -> Metrics : Record batch metrics
    activate Metrics
    Metrics -> Metrics : Compute batch statistics\n(CSAT, AHT, SLA, Gini)
    Metrics --> Simulator : Batch metrics recorded
    
    Simulator -> Scorer : Update dual variables
    Scorer -> Scorer : λ ← max(0, λ + η·(violation - budget))
    
    Simulator -> Simulator : Decay agent loads (simulate completion)
    deactivate Metrics
    deactivate Simulator
end

== Visualization & Reporting Phase ==

Main -> Viz : Generate visualizations
activate Viz

Main -> Metrics : Get all metrics
Metrics --> Viz : Metrics DataFrames

Viz -> Viz : Plot policy comparison
Viz -> Viz : Plot convergence analysis
Viz -> Viz : Plot agent workload
Viz --> Main : Save PNG files to data/logs/

Main -> Main : Generate final report
Main -> Main : Save CSV logs
Main --> User : Execution complete

== API Integration (Alternative Flow) ==

User -> Frontend : Open dashboard
Frontend -> API : GET /api/config
API --> Frontend : Configuration data

Frontend -> API : POST /api/simulation/start
activate API

API -> Simulator : Start simulation
Simulator -> Simulator : Run batches in background thread

loop Real-time updates
    Simulator -> Metrics : Get current metrics
    Metrics --> Simulator : Latest metrics
    Simulator -> API : Emit WebSocket update
    API -> Frontend : metrics_update event
    Frontend -> Frontend : Update UI (charts, KPIs, agent grid)
end

API --> Frontend : Simulation complete
deactivate API

@enduml

